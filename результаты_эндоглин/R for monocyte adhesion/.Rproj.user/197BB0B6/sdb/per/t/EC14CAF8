{
    "collab_server" : "",
    "contents" : "\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(cowplot)\nlibrary(lmerTest)\nlibrary(multcomp)\n\npath <- \"D:/Google Drive/материалы для отчета по гранту/adhesion_THP1_U937/Илья/\"\nsetwd(path)\n\n## ----The Theme-----------------------------------------------------------------------------------\n\nsource(\"D:/Google Drive/материалы для статьи функциональные тесты/Figure_theme.R\")\n\n## ----Constants-----------------------------------------------------------------------------------\n\nMAbs <- c(\"control\", \"3A7\", \"2C8\", \"4C9\", \"4E4\", \"5H7\")\nMAbs_TGF <- c(\"control\", \"TGF-beta\", \"3A7+TGF-beta\", \"2C8+TGF-beta\", \"4C9+TGF-beta\", \"4E4+TGF-beta\", \"5H7+TGF-beta\")\n\n## ----Fucntions-----------------------------------------------------------------------------------\n\nread_file <- function(filename) {\n        df <- read.csv(file = filename, sep = \";\", dec = \",\")\n        df$exp <- basename(filename)\n        df\n}\n\nread_files <- function(path = getwd(), files) {\n        do.call(rbind, lapply(file.path(path, files), read_file))\n}\n\nstrip_filename <- function(filename) {\n        stripped <- str_remove(str_remove(filename, \"report_\"), \".csv\")\n        stripped\n}\n\nread_data <- function(files, type.mab = \"mab\") {\n        df <- read_files(files = files)\n        df$mab <- strip_filename(df$file)\n        if (type.mab == \"mab\") {\n                df$mab <- factor(df$mab, levels = MAbs)\n        } else {\n                df$mab <- factor(df$mab, levels = MAbs_TGF)\n        }\n        df\n}\n\ncontrast_readable <- function(contrasts, round) {\n        df <- data.frame(Contrasts = contrasts$contrasts$Contrast,\n                         p.value = round(contrasts$contrasts$p.value, round))\n        df\n}\n\ntext_to_df <- function(text){\n        read.table(textConnection(text), header = T)\n}\n\nadd_first <- function(x) {\n        x.last <- x[1] + x[-1]\n        new.x <- c(x[1], x.last)\n        new.x\n}\n\nglm_stat <- function(data, type.mab = \"mab\") {\n        model <- glm(left.circles ~ mab, data, family = \"poisson\")\n        summary.model <- summary(model)\n        CI <- confint(model)\n        mab <- if(type.mab == \"mab\") factor(MAbs, levels = MAbs) else factor(MAbs_TGF, levels = MAbs_TGF)\n        result <- data.frame(mab = mab,\n                             mean = exp(add_first(summary.model$coef[,1])),\n                             CI.lower = exp(add_first(CI[,1])),\n                             CI.upper = exp(add_first(CI[,2])))\n        contr <- summary(glht(model, linfct = mcp(mab = \"Tukey\")))\n        list(result = result, contrasts = contr, model = model)\n}\n\n\n## ----Data----------------------------------------------------------------------------------------\n\nTHP.files <- list.files(\"Short incubation/THP-1/\", pattern = \"*.csv\", full.names = T)\nTHP_short <- read_data(THP.files)\n\nU937.files <- list.files(\"Short incubation/U937/\", pattern = \"*.csv\", full.names = T)\nU937_short <- read_data(U937.files)\n\nTHP.files2 <- list.files(\"Long incubation/THP-1/\", pattern = \"*.csv\", full.names = T)\nTHP_long <- read_data(THP.files2, type.mab = \"mab.tgf\")\n\nU937.files2 <- list.files(\"Long incubation/U937/\", pattern = \"*.csv\", full.names = T)\nU937_long <- read_data(U937.files2, type.mab = \"mab.tgf\")\n\n\n## ----Raw data figures (Short incubation)---------------------------------------------------------\n\nggplot(THP_short, aes(mab, left.circles+removed.circles)) +\n        geom_jitter(aes(color = exp), width = 0.15, size = 2.5, alpha = 0.75) +\n        theme_bw()\n\n\nggplot(U937_short, aes(mab, left.circles+removed.circles)) +\n        geom_jitter(aes(color = exp), width = 0.15, size = 2.5, alpha = 0.75) +\n        theme_bw()\n\n\nggplot(THP_long, aes(mab, left.circles+removed.circles)) +\n        geom_jitter(aes(color = exp), width = 0.15, size = 2.5, alpha = 0.75) +\n        theme_bw()\n\n\nggplot(U937_long, aes(mab, left.circles+removed.circles)) +\n        geom_jitter(aes(color = exp), width = 0.15, size = 2.5, alpha = 0.75) +\n        theme_bw()\n\nU937_long[U937_long$mab == \"control\", c(\"mab\", \"left.circles\")]\n\nU937_long <- U937_long[-c(99, 102),]\n\n## ----Statistics----------------------------------------------------------------------------------\n\n#       THP-1 short incubation\n\nTHP_short.model <- glmer(left.circles ~ mab + (1|exp), data = THP_short, family = \"poisson\")\n\nsummary(THP_short.model)\nplot(THP_short.model)\n\nTHP_short_contr <- psycho::get_contrasts(THP_short.model, formula = \"mab\", adjust = \"bonferroni\")\ncontrast_readable(THP_short_contr, 5)\n\nTHP_short_result <- \ndata.frame(\n        mab = THP_short_contr$means$mab,\n        mean = exp(THP_short_contr$means$Mean),\n        CI.lower = exp(THP_short_contr$means$CI_lower),\n        CI.upper = exp(THP_short_contr$means$CI_higher))\n\nTHP_short_result$mab <- factor(THP_short_result$mab, levels = MAbs)\n\n\n#       U937 short incubation\n\nU937_short_list <- glm_stat(U937_short)\n# plot(U937_short_list[[3]])\n\n\nTHP_long_list <- glm_stat(THP_long, type.mab = \"mab.tgf\")\n# plot(THP_long_list[[3]])\n\n#       U937 long incubation\n\nU937_long_list <- glm_stat(U937_long, type.mab = \"mab.tgf\")\n# plot(U937_long_list[[3]])\n\n\n## ----Figures-------------------------------------------------------------------------------------\n\n#       THP-1 short incubation\n\nTHP_short_lines <-\ntext_to_df(\n\"line  path     y\n    1     1  1800\n    1     2  1800\n    2     2  2000\n    2     6  2000\n    3     2  1950\n    3     5  1950\n    4     2  1900\n    4     4  1900\")\n\nTHP_short_stars <-\ntext_to_df(\n\"  x    y stars\n 1.5 1850   ***\n 3.0 2050   ***\"\n)\n\nfig_THP_short <-\nggplot(THP_short_result, aes(mab, mean)) +\n        geom_bar(stat = \"identity\", width = 0.45, color = \"black\", fill = \"grey\") +\n        geom_errorbar(width = 0.25, aes(ymin = CI.lower, ymax = CI.upper)) +\n        geom_line(data = THP_short_lines, aes(path, y, group = line)) +\n        geom_text(data = THP_short_stars, aes(x, y, label = stars), size = 7) +\n        my_theme +\n        theme(plot.title = element_text(hjust = 0.5, face = \"bold\")) +\n        ggtitle(\"THP-1\")\n\nfig_THP_short_rus <- fig_THP_short +\n        scale_x_discrete(labels = c(\"К\", \"IgG1\", \"2C8\", \"4C9\", \"4E4\", \"5H7\")) +\n        labs(x = \"\", y = \"Кол-во прикрепившихся клеток\")\n\nfig_THP_short_eng <- fig_THP_short +\n        scale_x_discrete(labels = c(\"Control\", \"IgG1\", \"2C8\", \"4C9\", \"4E4\", \"5H7\")) +\n        labs(x = \"\", y = \"Number of cells attached\")\n\n#       U937 short incubation\n\nU937_short_lines <-\ntext_to_df(\n\"line  path     y\n    1     1   450\n    1     2   450\n    2     2   600\n    2     6   600\n    3     2   580\n    3     5   580\n    4     2   560\n    4     4   560\n    5     2   540\n    5     3   540\")\n\nU937_short_stars <-\ntext_to_df(\n\"  x    y stars\n 1.5  470     *\n 2.5  620   ***\"\n)\n\nfig_U937_short <-\nggplot(U937_short_list[[1]], aes(mab, mean)) +\n        geom_bar(stat = \"identity\", width = 0.45, color = \"black\", fill = \"grey\") +\n        geom_errorbar(width = 0.25, aes(ymin = CI.lower, ymax = CI.upper)) +\n        geom_line(data = U937_short_lines, aes(path, y, group = line)) +\n        geom_text(data = U937_short_stars, aes(x, y, label = stars), size = 7) +\n        my_theme +\n        theme(plot.title = element_text(hjust = 0.5, face = \"bold\")) +\n        ggtitle(\"U937\")\n\nfig_U937_short_rus <- fig_U937_short +\n        scale_x_discrete(labels = c(\"К\", \"IgG1\", \"2C8\", \"4C9\", \"4E4\", \"5H7\")) +\n        labs(x = \"\", y = \"Кол-во прикрепившихся клеток\")\n\nfig_U937_short_eng <- fig_U937_short +\n        scale_x_discrete(labels = c(\"Control\", \"IgG1\", \"2C8\", \"4C9\", \"4E4\", \"5H7\")) +\n        labs(x = \"\", y = \"Number of cells attached\")\n\n\n#       THP-1 long incubation\n\nTHP_long_lines <-\ntext_to_df(\n\"line  path     y\n    1     1  1400\n    1     2  1400\n    2     2  1500\n    2     3  1500\n    3     3  1750\n    3     7  1750\n    4     3  1700\n    4     6  1700\n    5     3  1650\n    5     4  1650\")\n\nTHP_long_stars <-\ntext_to_df(\n\"  x    y stars\n 1.5 1450   ***\n 2.5 1550   ***\n 3.5 1800   ***\"\n)\n\nfig_THP_long <- \nggplot(THP_long_list[[1]], aes(mab, mean)) +\n        geom_bar(stat = \"identity\", width = 0.45, color = \"black\", fill = \"grey\") +\n        geom_errorbar(width = 0.25, aes(ymin = CI.lower, ymax = CI.upper)) +\n        geom_line(data = THP_long_lines, aes(path, y, group = line)) +\n        geom_text(data = THP_long_stars, aes(x, y, label = stars), size = 7) +\n        my_theme +\n        theme(plot.title = element_text(hjust = 0.5, face = \"bold\"),\n              axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1)) +\n        ggtitle(\"THP-1\")\n\nfig_THP_long_rus <- fig_THP_long +\n        scale_x_discrete(labels = c(\"К\", \"+TGF\", \"IgG1+TGF\", \"2C8+TGF\", \"4C9+TGF\", \"4E4+TGF\", \"5H7+TGF\")) +\n        labs(x = \"\", y = \"Кол-во прикрепившихся клеток\")\n\nfig_THP_long_eng <- fig_THP_long +\n        scale_x_discrete(labels = c(\"Control\", \"+TGF\", \"IgG1+TGF\", \"2C8+TGF\", \"4C9+TGF\", \"4E4+TGF\", \"5H7+TGF\")) +\n        labs(x = \"\", y = \"Number of cells attached\")\n\n#       U937 long incubation\nU937_long_lines <-\ntext_to_df(\n\"line  path     y\n    1     1   800\n    1     2   800\n    2     2   750\n    2     3   750\n    3     3  1050\n    3     7  1050\n    4     3  1000\n    4     6  1000\n    5     3   950\n    5     5   950\n    6     3   900\n    6     4   900\")\n\nU937_long_stars <-\ntext_to_df(\n\"  x    y stars\n 1.5  850   ***\n 2.5  800    **\n 3.5 1100   ***\"\n)\n\nfig_U937_long <-\nggplot(U937_long_list[[1]], aes(mab, mean)) +\n        geom_bar(stat = \"identity\", width = 0.45, color = \"black\", fill = \"grey\") +\n        geom_errorbar(width = 0.25, aes(ymin = CI.lower, ymax = CI.upper)) +\n        geom_line(data = U937_long_lines, aes(path, y, group = line)) +\n        geom_text(data = U937_long_stars, aes(x, y, label = stars), size = 7) +\n        my_theme +\n        theme(plot.title = element_text(hjust = 0.5, face = \"bold\"),\n              axis.text.x = element_text(angle = 25, hjust = 1, vjust = 1)) +\n        ggtitle(\"U937\")\n\nfig_U937_long_rus <- fig_U937_long +\n        scale_x_discrete(labels = c(\"К\", \"+TGF\", \"IgG1+TGF\", \"2C8+TGF\", \"4C9+TGF\", \"4E4+TGF\", \"5H7+TGF\")) +\n        labs(x = \"\", y = \"Кол-во прикрепившихся клеток\")\n\nfig_U937_long_eng <- fig_U937_long +\n        scale_x_discrete(labels = c(\"Control\", \"+TGF\", \"IgG1+TGF\", \"2C8+TGF\", \"4C9+TGF\", \"4E4+TGF\", \"5H7+TGF\")) +\n        labs(x = \"\", y = \"Number of cells attached\")\n\n\n## ----Final plots---------------------------------------------------------------------------------\n\nfig_rus <-\nggdraw() +\n        draw_plot(fig_THP_short_rus, x = 0, y = 0.55, width = 0.5, height = 0.45) +\n        draw_plot(fig_U937_short_rus, x = 0.5, y = 0.55, width = 0.5, height = 0.45) +\n        draw_plot(fig_THP_long_rus, x = 0, y = 0, width = 0.5, height = 0.55) +\n        draw_plot(fig_U937_long_rus, x = 0.5, y = 0, width = 0.5, height = 0.55) +\n        draw_plot_label(label = c(\"А\", \"Б\", \"В\", \"Г\"), x = c(0, 0.5, 0, 0.5),\n                        y = c(1, 1, 0.55, 0.55), size = 12)\n\nggsave(\"adhesion_to_cells-rus.jpeg\", fig_rus, width = 18, height = 16, units = \"cm\")\n\nfig_eng <-\n        ggdraw() +\n        draw_plot(fig_THP_short_eng, x = 0, y = 0.55, width = 0.5, height = 0.45) +\n        draw_plot(fig_U937_short_eng, x = 0.5, y = 0.55, width = 0.5, height = 0.45) +\n        draw_plot(fig_THP_long_eng, x = 0, y = 0, width = 0.5, height = 0.55) +\n        draw_plot(fig_U937_long_eng, x = 0.5, y = 0, width = 0.5, height = 0.55) +\n        draw_plot_label(label = c(\"А\", \"B\", \"C\", \"D\"), x = c(0, 0.5, 0, 0.5),\n                        y = c(1, 1, 0.55, 0.55), size = 12)\n\nggsave(\"adhesion_to_cells-eng.jpeg\", fig_eng, width = 18, height = 16, units = \"cm\")\n\n",
    "created" : 1540191494748.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3015721991",
    "id" : "EC14CAF8",
    "lastKnownWriteTime" : 1539347153,
    "last_content_update" : 1539347153,
    "path" : "D:/Анастасия Столбовая/результаты_эндоглин/R for monocyte adhesion/adhesion_to_cells2.R",
    "project_path" : "adhesion_to_cells2.R",
    "properties" : {
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}